---
title: "Monitor Federal de Salud"
author: "Miguel Albornoz"
format: 
  dashboard:
    theme: [zephyr, estilo.scss]
    fill: true  # Esto obliga a los gr치ficos a ocupar todo el espacio
nav-buttons:
  - icon: github
    href: https://github.com/micky-fearnot
---

```{r}
#| context: setup
#| include: false
library(tidyverse)

# 1. Carga de Datos (Lado del Servidor/R)
data <- read_rds("data/processed/pronostico_final.rds")

# 2. Serializaci칩n (Puente R -> JavaScript)
# Usamos ojs_define para pasar los datos de forma segura y eficiente
ojs_define(data_r = data)
```

```{ojs}
//| output: false
// 3. Hidrataci칩n de Datos (Lado del Cliente/JS)
// Transponemos los datos recibidos de R (que vienen por columnas) y parseamos las fechas
data = transpose(data_r).map(d => ({
  ...d,
  ds: new Date(d.ds) 
}))
```

# {.sidebar}
### Filtros Din치micos
Seleccione Jurisdicci칩n y Patolog칤a para visualizar la curva epid칠mica proyectada.

```{ojs}
//| panel: input

// Selector 1: Extrae provincias 칰nicas y crea el men칰
viewof selectedProv = Inputs.select(
  data.map(d => d.provincia_nombre), 
  {unique: true, label: "游늸 Provincia:", value: "Ciudad Aut칩noma de Buenos Aires"}
)

// Selector 2: Extrae enfermedades 칰nicas y crea el men칰
viewof selectedDisease = Inputs.select(
  data.map(d => d.enfermedad), 
  {unique: true, label: "游 Patolog칤a:", value: "Bronquiolitis"}
)
```


# Tablero de Comando

```{ojs}
// 1. Creamos el t칤tulo din치mico usando "Template Literals" (las comillas invertidas ``)
md`### Evoluci칩n Semanal de Casos: ${selectedDisease} (${selectedProv})`

Plot.plot({
  // Aumentamos el margen inferior para que la etiqueta centrada no se pegue al borde
  marginBottom: 50,
  marks: [
    Plot.ruleY([0]),
    
    // CAPA 1: 츼rea de Incertidumbre (Sombra)
    // Filtramos din치micamente seg칰n lo que el usuario eligi칩 arriba
    Plot.areaY(data.filter(d => d.provincia_nombre == selectedProv && d.enfermedad == selectedDisease), {
      x: "ds", 
      y1: "yhat_lower", 
      y2: "yhat_upper", 
      fill: "type", 
      fillOpacity: 0.2
    }),
    
    // CAPA 2: L칤nea Principal (Tendencia)
    Plot.line(data.filter(d => d.provincia_nombre == selectedProv && d.enfermedad == selectedDisease), {
      x: "ds", 
      y: "yhat", 
      stroke: "type", 
      strokeWidth: 3
    }),
    
    // CAPA 3: Interacci칩n (Tooltip al pasar el mouse)
    Plot.tip(data.filter(d => d.provincia_nombre == selectedProv && d.enfermedad == selectedDisease), 
      Plot.pointerX({
        x: "ds", 
        y: "yhat", 
        title: d => `Fecha: ${d.ds.toLocaleDateString('es-AR')}\nCasos Est.: ${Math.round(d.yhat)}`
      })
    )
  ],
  x: {
    label: "Fecha", 
    // Centramos la etiqueta 
    labelAnchor: "center",
    // La bajamos un poco para que no se mezcle con los a침os 
    labelOffset: 40,
    tickFormat: "%b %Y"},
  y: {
    label: "Casos Semanales",
    grid: true,
    tickFormat: d => d.toLocaleString('es-AR') // Agrega puntos de miles autom치ticamente
    },
  color: {domain: ["Hist칩rico", "Proyecci칩n"], range: ["#1A3243", "#FF7F50"]},
  style: {fontSize: "14px", fontFamily: "sans-serif"}
})
```


# An치lisis Comparativo {orientation="columns"}

## Column {width=60%}

```{ojs}
// 1. Agrupamos y sumamos las proyecciones por provincia
md`### Carga Epidemiol칩gica Proyectada: ${selectedDisease}
*Sumatoria total de casos estimada para las pr칩ximas 52 semanas (1 a침o).*`
md`Seleccione una patolog칤a arriba para ver cu치les provincias requieren m치s atenci칩n.`

provincial_ranking = d3.rollups(
  data.filter(d => d.enfermedad == selectedDisease && d.type == "Proyecci칩n"),
  v => d3.sum(v, d => d.yhat),
  d => d.provincia_nombre
)
.map(([provincia, total]) => ({ provincia, total }))
.sort((a, b) => d3.descending(a.total, b.total))
.slice(0, 10) // Top 10

// 2. Gr치fico de Barras Horizontales
Plot.plot({
  marginLeft: 150,
  marginRight: 100,
  height: 750, // <--- AUMENTAMOS ESTO SIGNIFICATIVAMENTE
  marginTop: 30, // Agregamos un poco de aire arriba de las barras
  marks: [
    Plot.barX(provincial_ranking, {
      x: "total", 
      y: "provincia", 
      fill: "#1A3243", // Tu azul institucional
      sort: {y: "-x"}
    }),
    Plot.text(provincial_ranking, {
      x: "total", 
      y: "provincia", 
      text: d => Math.round(d.total).toLocaleString('es-AR'), 
      dx: 5, 
      textAnchor: "start"
    })
  ],
  x: {label: "Total Casos Proyectados", grid: true},
  y: {label: ""}
})
```

## Column {width=40%}


```{ojs}
// 1. Datos para gr치fico de torta/donas
md`### Distribuci칩n por Patolog칤a en ${selectedProv}`
md`Comparaci칩n del volumen total hist칩rico de las tres enfermedades en la jurisdicci칩n seleccionada.`

disease_comp = d3.rollups(
  data.filter(d => d.provincia_nombre == selectedProv && d.type == "Hist칩rico"),
  v => d3.sum(v, d => d.y), // 
  d => d.enfermedad
)
.map(([label, value]) => ({ label, value }))
// 2. Gr치fico de Donut
Plot.plot({
  height: 300,
  marks: [
    Plot.barY(disease_comp, {
      x: "label", 
      y: "value", 
      fill: "label",
      inset: 0.5
    })
  ],
  color: {
    domain: ["Bronquiolitis", "Influenza (Gripe)", "Neumon칤a"],
    range: ["#1A3243", "#FF7F50", "#29BDEF"] // Azul, Salm칩n, Cian
  },
  y: {grid: true, label: "Total Hist칩rico acumulado"}
})
```